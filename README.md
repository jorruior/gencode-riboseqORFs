## README

This readme is a guideline for any user that wants to use the main Methods to generate an unified set of Ribo-seq ORFs in this article: X

While this script is designed to unify independent sets of ORFs and mapped them to a specific Ensembl version, it is not a tool to analyze ribosome-profiling data. However, GENCODE plans a Phase II to re-analyze ribosome-profiling datasets and generate consistent sets of ORFs.


**DEPENDENCIES:**

This script is based on Python3 and Bash, requiring some additional packages to correctly run all steps:

-**gffread** (v0.1.10) http://ccb.jhu.edu/software/stringtie/dl/gffread-0.12.6.tar.gz

-**bedtools** (v2.27.1 or newer) https://github.com/arq5x/bedtools2

-**Python packages: Biopython**


**INPUT ANNOTATION FILES**: 

This pipeline requires a series of files in the correct format to analyze the data. First of all, the user will be required to collect a series of annotation files in a single folder <FOLDER>. These files can be downloaded from Ensembl or GENCODE; we also included a bash script to automatically download and convert all files for a specific Ensembl release:
```
bash scripts/retrieve_ensembl_data.sh <ENSEMBL_RELEASE (e.g. 101)> <GENOME_ASSEMBLY (e.g. GRCh38)>
```
Files will be stored in a new <FOLDER> named 'Ens + number of release'. The files are:
       
PROTEOME_FASTA: Fastq file with all annotated proteins. The protein ID should be the only element in the header.

TRANSCRIPTOME_FASTA: Fasta file with all transcripts. It should include both mRNA and ncRNA, and the transcript ID should be the only element in the header.

SORTED_TRANSCRIPTOME_GTF: Sorted GTF file with exon and CDS sequences for the transcripts included in TRANSCRIPTOME_FASTA -Ensembl format-. Transcript IDs (field 'transcript_id') and protein IDs (field 'protein_id') should match with the IDs in the fasta files. A GTF can be sorted running this command in bash:
```
sort -k1,1 -k4,4n -k5,5n <TRANSCRIPTOME_GTF> > <SORTED_TRANSCRIPTOME_GTF>
```
TRANSCRIPT_SUPPORT: Tab-delimited file containing all transcripts IDs, Transcript Support Level (TSL) scores, and APPRIS support scores. This file will be used to prioritize transcripts that translate each ORF.

PSITES_BED: File including coordinates of P-sites for the annotated proteins. This file can be obtained from the fasta file by running:
```
python3 ../scripts/calculate_frame_bed.py <SORTED_TRANSCRIPTOME_GTF>
```

**INPUT ORF FILES:**

In addition, the pipeline will require input files with the protein sequences and coordinates of the ORFs that will be inspected and unified, tagged by study. Ideally both sequences and exonic coordinates should be included, but ORF studies are very heterogeneous and sometimes only sequences or coordinates are available. If only the protein sequences are available, please use the **-a** option in the main script. If only the exonic coordinates are available, it is possible to run a in-house script to convert **1-based (Important: All BED/GTF coordinate files should be 1-based)** BED coordinates (<BED_FILE>) into protein sequences:
```
bash scripts/bed1_to_fasta.sh <BED_FILE>
```
Outputs: <BED_FILE>.nucl.fa and <BED_FILE>.prot.fa   


MAIN SCRIPT) **ORF_mapper_to_GENCODE.py** (--help):
```
python3 ORF_mapper_to_GENCODE.py -d <FOLDER> -f <ORFS_FA_FILE> -b <ORFS_BED_FILE (1-based)>

  -d FOLDER, --input_dir=FOLDER
                        (Required) Directory with required Ensembl files (transcriptome
                        gft and fasta, proteome fasta, tab file with APPRIS
                        and TSL support, protein psites generated by
                        'calculate_frame_bed.py'. Files are already available
                        for Ens101 and the latest GENCODE version.
  -f ORFS_FA_FILE, --input_fasta=ORFS_FA_FILE
                        (Required) File with all translated candidate ORFs. A FASTA can
                        be generated from a BED file using the script
                        'bed1_to_fasta.sh'
  -b ORFS_BED_FILE, --input_bed=ORFS_BED_FILE
                        File with 1-based BED coordinates of all translated
                        candidate ORFs. ORF names should match in both fasta
                        and bed files. If -m is activated, the BED coordinates will
                        be written into this file.
  -l LEN_CUTOFF, --len_cutoff=LEN_CUTOFF
                        Minimum ORF length threshold in amino acids (without
                        stop codon). default=16
  -c COL_THR, --collapse_cutoff=COL_THR
                        Minimum required fraction to collapse ORFs with
                        similar stretches of overlapping amino-acid sequences.
                        default=0.9
  -m METHOD, --collapse_method=METHOD
                        Method to cluster ORF variants. 'longest_string' will
                        collapse ORFs if the longest shared string is above -c
                        threshold (default). 'psite_overlap' is a slower
                        method that collapses ORFs if the fraction of shared
                        psites is above -c threshold
  -a CALCULATE_COORDINATES, --make_annot_bed=CALCULATE_COORDINATES
                        If ORF BED file is not available, generate it from the
                        FASTA file. (ATG/NTG/XTG/no, default = no)

```
As previously commented, if the BED including ORF coordinates is not available, the option **-a** should be enabled and the BED file will be written into the file specified by the option **-b**. If **-a** is set to *no* (default), the **-b** BED file will be used as input for extracting ORF coordinates. **-a** has three different writing options: **ATG** will write all ORF starting with ATG codon; **NTG** will write all ORFs starting with non-ATG codons, **XTG** will write all ORFs regardless of the translation initiation codon. The first Phase I ORF dataset was generated including uniquely ATG ORFs.

In addition, the script includes the parameter **-m** which offers two options for collapsing ORFs located in the same locus and sharing some degree of similarity. **'longest_string'** is the default parameter used to calculate Phase I ORFs and will collapse ORFs when the X. The minimum required fraction to collapse ORFs is defined by the parameter **-c** (default: 0.9). In both cases the longest ORF will be selected as representative.

